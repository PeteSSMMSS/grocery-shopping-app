import { useState, useEffect } from 'react'
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import             <MobileShoppingList
              items={activeList?.items || []}
              onToggleItem={(id) => {
                const item = activeList?.items.find(i => i.id === id)
                if (item) {
                  updateItemMutation.mutate({
                    id,
                    data: { purchased: !item.purchased }
                  })
                }
              }}
              onDeleteItem={(id) => removeItemMutation.mutate(id)}
            />ib/api'
import ListPane from './components/ListPane'
import CatalogPane from './components/CatalogPane'
import SettingsModal from './components/SettingsModal'
import MealsModal from './components/MealsModal'
import CalendarModal from './components/CalendarModal'
import Toast from './components/Toast'
import MobileBottomNav from './components/MobileBottomNav'
import MobileShoppingList from './components/MobileShoppingList'
import MobileFAB from './components/MobileFAB'

function App() {
  const queryClient = useQueryClient()
  const [isSettingsOpen, setIsSettingsOpen] = useState(false)
  const [isMealsOpen, setIsMealsOpen] = useState(false)
  const [isCalendarOpen, setIsCalendarOpen] = useState(false)
  const [online, setOnline] = useState(navigator.onLine)
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' } | null>(null)
  const [isMobile, setIsMobile] = useState(false)
  const [mobileTab, setMobileTab] = useState('list')

  // Detect mobile device
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768) // Tablets & phones
    }
    checkMobile()
    window.addEventListener('resize', checkMobile)
    return () => window.removeEventListener('resize', checkMobile)
  }, [])

  // Monitor online/offline status
  window.addEventListener('online', () => setOnline(true))
  window.addEventListener('offline', () => setOnline(false))

  // Fetch active list
  const { data: activeList, isLoading } = useQuery({
    queryKey: ['activeList'],
    queryFn: () => api.list.getActive(),
    refetchInterval: online ? 10000 : false, // Refetch every 10s when online
  })

  // Fetch products
  const { data: products = [] } = useQuery({
    queryKey: ['products'],
    queryFn: () => api.products.getAll({ active: true }),
  })

  // Fetch categories
  const { data: categories = [] } = useQuery({
    queryKey: ['categories'],
    queryFn: () => api.categories.getAll(),
  })

  // Add item to list
  const addItemMutation = useMutation({
    mutationFn: ({ product_id, qty }: { product_id: number; qty: number }) =>
      api.list.addItem(product_id, qty),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['activeList'] })
    },
  })

  // Update item
  const updateItemMutation = useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) =>
      api.list.updateItem(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['activeList'] })
    },
  })

  // Remove item
  const removeItemMutation = useMutation({
    mutationFn: (id: number) => api.list.removeItem(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['activeList'] })
    },
  })

  // Checkout - Creates shopping event and clears list
  const checkoutMutation = useMutation({
    mutationFn: async () => {
      if (!activeList) return
      
      // Calculate total price
      const totalPrice = activeList.items.reduce(
        (sum, item) => sum + (item.product.current_price || 0) * item.qty,
        0
      )
      
      // Create shopping event
      await api.shoppingEvents.create({
        name: 'Einkauf',
        event_date: new Date().toISOString().split('T')[0], // YYYY-MM-DD
        total_price_cents: totalPrice,
        items: activeList.items.map(item => ({
          product_id: item.product.id,
          product_name: item.product.name,
          qty: item.qty,
          price_cents: item.product.current_price || 0,
        })),
      })
      
      // Then checkout
      await api.purchase.checkout()
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['activeList'] })
      queryClient.invalidateQueries({ queryKey: ['shopping-events'] })
      setToast({ message: '‚úÖ Einkauf erfolgreich gespeichert!', type: 'success' })
    },
  })

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-screen bg-[#1f1f1f]">
        <div className="text-xl text-neutral-300">Lade...</div>
      </div>
    )
  }

  // Mobile View
  if (isMobile) {
    return (
      <div className="h-screen flex flex-col bg-[#282828]">
        {/* Mobile Content */}
        {mobileTab === 'list' && (
          <>
            <MobileShoppingList
              items={activeList?.items || []}
              onToggleItem={(id) => {
                const item = activeList?.items.find(i => i.id === id)
                if (item) {
                  updateItemMutation.mutate({
                    id,
                    data: { is_purchased: !item.is_purchased }
                  })
                }
              }}
              onDeleteItem={(id) => removeItemMutation.mutate(id)}
            />
            <MobileFAB onClick={() => setMobileTab('catalog')} />
          </>
        )}

        {mobileTab === 'catalog' && (
          <div className="flex-1 overflow-auto pb-20">
            <CatalogPane
              products={products}
              categories={categories}
              onAddToList={(productId) => {
                addItemMutation.mutate({ product_id: productId, qty: 1 })
                setToast({ message: '‚úÖ Zur Liste hinzugef√ºgt!', type: 'success' })
              }}
            />
          </div>
        )}

        {mobileTab === 'calendar' && (
          <div className="flex-1 overflow-auto pb-20">
            <CalendarModal
              onClose={() => setMobileTab('list')}
            />
          </div>
        )}

        {mobileTab === 'settings' && (
          <div className="flex-1 overflow-auto pb-20">
            <SettingsModal
              onClose={() => setMobileTab('list')}
              products={products}
              categories={categories}
              onRefresh={() => {
                queryClient.invalidateQueries({ queryKey: ['products'] })
                queryClient.invalidateQueries({ queryKey: ['categories'] })
              }}
            />
          </div>
        )}

        {/* Bottom Navigation */}
        <MobileBottomNav activeTab={mobileTab} onTabChange={setMobileTab} />

        {/* Toast */}
        {toast && (
          <Toast
            message={toast.message}
            type={toast.type}
            onClose={() => setToast(null)}
          />
        )}
      </div>
    )
  }

  // Desktop View (original)
  return (
    <div className="h-screen flex flex-col bg-[#1f1f1f]">
      {/* Header */}
      <header className="bg-[#282828] shadow-lg border-b border-neutral-800">
        <div className="px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <h1 className="text-2xl font-bold text-neutral-100">üõí Einkaufsliste</h1>
            {!online && (
              <span className="px-2 py-1 text-xs font-medium bg-amber-600 text-amber-100 rounded">
                Offline
              </span>
            )}
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={() => checkoutMutation.mutate()}
              disabled={!activeList?.items.length || checkoutMutation.isPending}
              className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors"
            >
              {checkoutMutation.isPending ? 'Erledigt...' : '‚úì Erledigt'}
            </button>
            <button
              onClick={() => setIsCalendarOpen(true)}
              className="px-4 py-2 bg-neutral-700 text-neutral-200 rounded-lg hover:bg-neutral-600 font-medium transition-colors"
            >
              üìÖ Kalender
            </button>
            <button
              onClick={() => setIsMealsOpen(true)}
              className="px-4 py-2 bg-neutral-700 text-neutral-200 rounded-lg hover:bg-neutral-600 font-medium transition-colors"
            >
              üç≥ Mahlzeiten
            </button>
            <button
              onClick={() => setIsSettingsOpen(true)}
              className="px-4 py-2 bg-neutral-700 text-neutral-200 rounded-lg hover:bg-neutral-600 font-medium transition-colors"
            >
              ‚öôÔ∏è Einstellungen
            </button>
          </div>
        </div>
      </header>

      {/* Main Content - Two Column Layout */}
      <main className="flex-1 overflow-hidden">
        <div className="h-full flex flex-col md:flex-row">
          {/* Left: Shopping List */}
          <div className="w-full md:w-1/2 border-r border-neutral-800 overflow-auto bg-[#282828]">
            <ListPane
              list={activeList}
              onUpdateItem={(id, data) => updateItemMutation.mutate({ id, data })}
              onRemoveItem={(id) => removeItemMutation.mutate(id)}
            />
          </div>

          {/* Right: Product Catalog */}
          <div className="w-full md:w-1/2 overflow-auto bg-[#1f1f1f]">
            <CatalogPane
              products={products}
              categories={categories}
              onAddToList={(productId) => addItemMutation.mutate({ product_id: productId, qty: 1 })}
            />
          </div>
        </div>
      </main>

      {/* Meals Modal */}
      {isMealsOpen && (
        <MealsModal
          onClose={() => setIsMealsOpen(false)}
          products={products}
          onRefresh={() => {
            queryClient.invalidateQueries({ queryKey: ['meals'] })
          }}
        />
      )}

      {/* Settings Modal */}
      {isSettingsOpen && (
        <SettingsModal
          onClose={() => setIsSettingsOpen(false)}
          products={products}
          categories={categories}
          onRefresh={() => {
            queryClient.invalidateQueries({ queryKey: ['products'] })
            queryClient.invalidateQueries({ queryKey: ['categories'] })
          }}
        />
      )}

      {/* Calendar Modal */}
      {isCalendarOpen && (
        <CalendarModal
          onClose={() => setIsCalendarOpen(false)}
        />
      )}

      {/* Toast Notification */}
      {toast && (
        <Toast
          message={toast.message}
          type={toast.type}
          onClose={() => setToast(null)}
        />
      )}
    </div>
  )
}

export default App
